<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="icon" href="12favicon.png" type="image/png">
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%; width: 100%;
      font-family: 'Roboto', sans-serif;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #e6e6e6;
      padding: 10px 20px;
      height: 80px;
      border-bottom: 1px solid #ccc;
    }
    .header-right {
      text-align: right;
    }
    .toggle-btn {
      font-size: 24px;
      background: #007bff;
      color: white;
      padding: 5px 10px;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      width: 40px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      display: flex;
      height: calc(100vh - 80px);
    }
    .sidebar {
      width: 250px;
      background: #fff;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: width 0.3s;
    }
    .sidebar.hidden {
      display: none;
    }
    .submenu {
      display: none;
      padding-left: 20px;
      list-style: none;
    }
    .submenu li {
      padding: 5px 0;
      cursor: pointer;
    }
    .sidebar h2 {
      margin: 0; padding: 10px;
      background: #f0f0f0;
      cursor: pointer;
    }
    .user-panel {
      padding: 10px;
      font-size: 12px;
      border-top: 1px solid #ccc;
      text-align: center;
    }
    .user-panel img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin-bottom: 10px;
    }
    .logout-btn {
      margin: 10px;
      padding: 8px;
      background: #dc3545;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    input, button, select, textarea {
      display: block;
      margin: 10px 0;
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
    }
    button.short-btn {
      width: 80px;
      margin: 5px 5px 10px 0;
      padding: 6px 10px;
      display: inline-block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table, th, td {
      border: 1px solid black;
      text-align: center;
    }
    #itemListTable { 
      display: none; 
      border: 1px solid #ccc; 
      max-height: 200px; 
      overflow-y: auto; 
      background: white;
      position: absolute;
      z-index: 9999;
      width: 90%;
      max-width: 600px;
      padding: 5px;
    }
    #itemListTable td { cursor: pointer; padding: 4px; }
    #itemListTable tr:hover { background-color: #e0e0e0; }
    .small-select {
      font-size: 12px;
      padding: 6px;
      width: 48%;
      display: inline-block;
      box-sizing: border-box;
    }
    .amount-boxes {
      width: 30%;
      float: right;
      margin-top: 20px;
      font-size: 14px;
    }
    .amount-boxes label, .amount-boxes input {
      display: block;
      margin-bottom: 5px;
    }
    .amount-boxes input {
      text-align: right;
      font-weight: bold;
    }
    .clearfix::after {
      content: "";
      clear: both;
      display: table;
    }
  </style>
</head>
<body onload="initDashboard()">
<header>
  <button class="toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
  <div class="header-right">
    <div><strong>Inventory Management System</strong></div>
    <div>Quick Product Search üîç</div>
  </div>
</header>
<div class="container">
  <div class="sidebar" id="sidebar">
    <div>
      <h2 onclick="toggleMenu('fileMenu')">My Files</h2>
      <ul class="submenu" id="fileMenu">
        <li onclick="showSection('itemMaster')">Item Master</li>
        <li onclick="showSection('myStock')">My Stock</li>
      </ul>
      <h2 onclick="toggleMenu('transactionMenu')">My Transactions</h2>
      <ul class="submenu" id="transactionMenu">
        <li onclick="showSection('purchaseOrder')">PO</li>
        <li onclick="showSection('grnSection')">GRN</li>
        <li onclick="showSection('transferInSection')">Transfer In</li>
        <li onclick="showSection('transferOutSection')">Transfer Out</li>
      </ul>
      <h2 onclick="toggleMenu('reportMenu')">My Reports</h2>
      <ul class="submenu" id="reportMenu">
        <li>Bin Card</li>
        <li>Stock Balance Report</li>
      </ul>
    </div>
    <div class="user-panel">
      <img src="user.png" alt="User" />
      <p><strong>User:</strong> <span id="userName"></span></p>
      <p><strong>Location:</strong> <span id="userLocation"></span></p>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="main-content">
    <!-- ITEM MASTER -->
    <div id="itemMaster" style="display:none; position:relative;">
      <h2>Item Master</h2>
      <form id="itemForm">
        <input type="text" id="itemCode" placeholder="Item Code (F2 to search)" onkeydown="handleItemCodeF2(event)" readonly />
        <input type="text" id="itemName" placeholder="Item Name" readonly />
        <input type="text" id="packSize" placeholder="Pack Size" readonly />
        <input type="number" id="costPrice" placeholder="Cost Price" readonly min="0" step="0.01" />
        <input type="number" id="sellPrice" placeholder="Selling Price" readonly min="0" step="0.01" />
        <input type="text" id="supplierName" placeholder="Supplier Name" readonly />

        <div>
          <button type="button" onclick="createItem()" id="createBtn" class="short-btn">Create</button>
          <button type="button" onclick="editItem()" id="editBtn" class="short-btn">Edit</button>
          <button type="button" onclick="saveItem()" id="saveBtn" class="short-btn" style="display:none;">Save</button>
          <button type="button" onclick="deleteItem()" id="deleteBtn" class="short-btn">Delete</button>
        </div>
      </form>

      <!-- Item search popup -->
      <div id="itemListTable" style="position:absolute; top:100px; left:10px; right:10px; max-height:250px; overflow-y:auto; border:1px solid #ccc; background:#fff; display:none;">
        <input type="text" id="itemSearchInput" placeholder="Search by code or name" oninput="filterItemList()" style="width:100%; margin-bottom:5px; box-sizing:border-box; padding:6px;" />
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr><th>Code</th><th>Item Name</th></tr>
          </thead>
          <tbody id="itemListBody"></tbody>
        </table>
      </div>
    </div>

    <!-- MY STOCK -->
    <div id="myStock" style="display:none;">
      <h2>My Stock</h2>
      <input type="text" id="stockItemCode" placeholder="Enter Item Code" onkeydown="handleStockItemF2(event)" readonly />
      <div id="stockItemName" style="font-weight:bold; margin-bottom:10px;"></div>
      <button onclick="checkStockItem()" class="short-btn" style="width:auto;">Check Stock</button>
      <div id="stockResult" style="margin-top: 10px; font-weight: bold;"></div>

      <!-- Stock item search popup -->
      <div id="stockItemListTable" style="position:absolute; top:140px; left:270px; max-height:250px; overflow-y:auto; border:1px solid #ccc; background:#fff; display:none; width:300px;">
        <input type="text" id="stockItemSearchInput" placeholder="Search by code or name" oninput="filterStockItemList()" style="width:100%; margin-bottom:5px; box-sizing:border-box; padding:6px;" />
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr><th>Code</th><th>Item Name</th></tr>
          </thead>
          <tbody id="stockItemListBody"></tbody>
        </table>
      </div>
    </div>

    <!-- TRANSFER IN -->
    <div id="transferInSection" style="display:none;">
      <h2>Transfer In</h2>
      <div>
        <label>Doc No: <input type="text" id="transferInDocNo" readonly style="width: 60px;" /></label>
        <label class="small-select" style="float:right; margin-left:5px;">From Location: 
          <select id="transferInFromLocation" class="small-select"></select>
        </label>
        <label class="small-select" style="float:right;">To Location: 
          <select id="transferInToLocation" class="small-select" disabled></select>
        </label>
      </div>
      <div style="clear:both; margin-top:5px;">
        <label>Remark:</label>
        <input type="text" id="transferInRemark" />
      </div>
      <table id="transferInTable">
        <thead>
          <tr>
            <th>NO</th><th>CODE</th><th>ITEM NAME</th><th>P/S</th><th>EXP DATE</th><th>COST</th><th>UNIT</th><th>AMOUNT</th><th>Remove</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button onclick="transferInAddItem()" class="short-btn">Add Item</button>
      <button onclick="transferInSave()" class="short-btn">Save</button>

      <div class="amount-boxes clearfix" style="float:right; margin-top:20px;">
        <label>Gross Amount</label>
        <input type="number" id="transferInGross" readonly value="0" />
        <label>Discount</label>
        <input type="number" id="transferInDiscount" value="0" oninput="transferInCalculate()" />
        <label>Tax</label>
        <input type="number" id="transferInTax" value="0" oninput="transferInCalculate()" />
        <label>Net Amount</label>
        <input type="number" id="transferInNet" readonly value="0" />
      </div>
    </div>

    <!-- TRANSFER OUT -->
    <div id="transferOutSection" style="display:none;">
      <h2>Transfer Out</h2>
      <div>
        <label>Doc No: <input type="text" id="transferOutDocNo" style="width: 60px;" /></label>
        <label class="small-select" style="float:right; margin-left:5px;">From Location: 
          <select id="transferOutFromLocation" class="small-select" disabled></select>
        </label>
        <label class="small-select" style="float:right;">To Location: 
          <select id="transferOutToLocation" class="small-select"></select>
        </label>
      </div>
      <div style="clear:both; margin-top:5px;">
        <label>Remark:</label>
        <input type="text" id="transferOutRemark" />
      </div>
      <table id="transferOutTable">
        <thead>
          <tr>
            <th>NO</th><th>CODE</th><th>ITEM NAME</th><th>P/S</th><th>EXP DATE</th><th>COST</th><th>SIH</th><th>UNIT</th><th>AMOUNT</th><th>Remove</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button onclick="transferOutAddItem()" class="short-btn">Add Item</button>
      <button onclick="transferOutSave()" class="short-btn" id="transferOutSaveBtn">Save</button>
      <button onclick="transferOutEdit()" class="short-btn" id="transferOutEditBtn" style="display:none;">Edit</button>
      <button onclick="transferOutProcess()" class="short-btn" id="transferOutProcessBtn" style="display:none;">Process</button>

      <div class="amount-boxes clearfix" style="float:right; margin-top:20px;">
        <label>Gross Amount</label>
        <input type="number" id="transferOutGross" readonly value="0" />
        <label>Discount</label>
        <input type="number" id="transferOutDiscount" value="0" oninput="transferOutCalculate()" />
        <label>Tax</label>
        <input type="number" id="transferOutTax" value="0" oninput="transferOutCalculate()" />
        <label>Net Amount</label>
        <input type="number" id="transferOutNet" readonly value="0" />
      </div>
    </div>

    <!-- PURCHASE ORDER -->
    <div id="purchaseOrder" style="display:none;">
      <h2>Purchase Order</h2>
      <textarea id="poRemark" placeholder="Remark"></textarea>
      <table id="poTable">
        <thead>
          <tr><th>Code</th><th>Name</th><th>PS</th><th>Cost</th><th>Qty</th><th>Amount</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <button onclick="addPOItem()" class="short-btn">Add Item</button>
      <button onclick="savePO()" class="short-btn">Save PO</button>
    </div>

    <!-- GRN -->
    <div id="grnSection" style="display:none;">
      <h2>GRN</h2>
      <input type="number" id="grnPOInput" placeholder="Enter PO Number" />
      <button onclick="loadGRNFromPO()" class="short-btn">Load PO</button>
      <table id="grnTable">
        <thead><tr><th>Code</th><th>Name</th><th>Qty</th><th>Cost</th><th>Total</th></tr></thead>
        <tbody></tbody>
      </table>
      <button onclick="saveGRN()" class="short-btn">Save GRN</button>
    </div>
  </div>
</div>

<script>
let itemDB = JSON.parse(localStorage.getItem("itemDB") || "{}");
let poDB = [];
let currentPONum = 1;

let transferInDB = [];
let transferOutDB = [];
let currentTransferOut = null;

const locations = ["WarehouseA", "WarehouseB", "WarehouseC"];

// Test item preload if not exist
if (!itemDB["1"]) {
  itemDB["1"] = {
    name: "Panadol 100ml",
    ps: "1",
    cost: 5,
    sell: 10,
    supplier: "Test Supplier",
    sih: 100,
    expDates: ["2026-05-30"]
  };
  localStorage.setItem("itemDB", JSON.stringify(itemDB));
}
// Test item preload if not exist
if (!itemDB["2"]) {
  itemDB["2"] = {
    name: "NEVOX XR",
    ps: "30",
    cost: 17,
    sell: 35,
    supplier: "Test Supplier",
    sih: 300,
    expDates: ["2026-05-30"]
  };
  localStorage.setItem("itemDB", JSON.stringify(itemDB));
}
function initDashboard() {
  const user = localStorage.getItem("username") || "User";
  const location = localStorage.getItem("location") || "WarehouseA";

  document.getElementById("userName").textContent = user;
  document.getElementById("userLocation").textContent = location;

  // Setup locations selects
  setupLocationSelects();

  // Setup doc numbers
  document.getElementById("transferInDocNo").value = transferInDB.length + 1;
  document.getElementById("transferOutDocNo").value = transferOutDB.length + 1;

  disableItemForm();

  // Hide all initially
  showSection();

  // Prepare stock input readonly false to allow F2 search in stock screen
  document.getElementById("stockItemCode").readOnly = false;

  // Pre-fill "to location" disabled in Transfer In (fixed)
  document.getElementById("transferInToLocation").disabled = true;
  document.getElementById("transferInToLocation").value = location;
  document.getElementById("transferInFromLocation").value = "";

  // For Transfer Out, fixed from location to current user location
  document.getElementById("transferOutFromLocation").value = location;

  // Setup event for discount/tax calculation
  document.getElementById("transferInDiscount").addEventListener("input", transferInCalculate);
  document.getElementById("transferInTax").addEventListener("input", transferInCalculate);
  document.getElementById("transferOutDiscount").addEventListener("input", transferOutCalculate);
  document.getElementById("transferOutTax").addEventListener("input", transferOutCalculate);

  // Add event listener for Transfer Out doc num enter key
  document.getElementById("transferOutDocNo").addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      e.preventDefault();
      loadTransferOutByDocNo();
    }
  });
}

// ---------- ITEM MASTER FUNCTIONS ----------

function createItem() {
  const code = (Object.keys(itemDB).length + 1).toString();
  if (
    !document.getElementById("itemName").value.trim() ||
    !document.getElementById("costPrice").value ||
    !document.getElementById("sellPrice").value
  ) {
    alert("Fill required fields (Item Name, Cost Price, Selling Price)");
    return;
  }
  itemDB[code] = {
    name: document.getElementById("itemName").value.trim(),
    ps: document.getElementById("packSize").value.trim(),
    cost: parseFloat(document.getElementById("costPrice").value),
    sell: parseFloat(document.getElementById("sellPrice").value),
    supplier: document.getElementById("supplierName").value.trim(),
    sih: 0,
    expDates: []
  };
  localStorage.setItem("itemDB", JSON.stringify(itemDB));
  alert("Item created: " + code);
  resetItemForm();
  document.getElementById("itemCode").value = code;
  disableItemForm();
  showEditDeleteButtons(true);
}

function editItem() {
  if (!document.getElementById("itemCode").value) {
    alert("Load an item first");
    return;
  }
  ["itemName", "packSize", "costPrice", "sellPrice", "supplierName"].forEach(id => {
    document.getElementById(id).readOnly = false;
  });
  showEditDeleteButtons(false);
}

function saveItem() {
  const code = document.getElementById("itemCode").value;
  if (!itemDB[code]) {
    alert("No such item");
    return;
  }
  if (
    !document.getElementById("itemName").value.trim() ||
    !document.getElementById("costPrice").value ||
    !document.getElementById("sellPrice").value
  ) {
    alert("Fill required fields (Item Name, Cost Price, Selling Price)");
    return;
  }
  itemDB[code].name = document.getElementById("itemName").value.trim();
  itemDB[code].ps = document.getElementById("packSize").value.trim();
  itemDB[code].cost = parseFloat(document.getElementById("costPrice").value);
  itemDB[code].sell = parseFloat(document.getElementById("sellPrice").value);
  itemDB[code].supplier = document.getElementById("supplierName").value.trim();
  localStorage.setItem("itemDB", JSON.stringify(itemDB));
  alert("Item updated: " + code);
  disableItemForm();
  showEditDeleteButtons(true);
}

function deleteItem() {
  const code = document.getElementById("itemCode").value;
  if (!code || !itemDB[code]) {
    alert("No item loaded to delete");
    return;
  }
  if (confirm("Delete item " + code + "?")) {
    delete itemDB[code];
    localStorage.setItem("itemDB", JSON.stringify(itemDB));
    alert("Item deleted");
    resetItemForm();
  }
}

function resetItemForm() {
  document.getElementById("itemForm").reset();
  document.getElementById("itemCode").value = "";
}

function disableItemForm() {
  ["itemName", "packSize", "costPrice", "sellPrice", "supplierName"].forEach(id => {
    document.getElementById(id).readOnly = true;
  });
}

function showEditDeleteButtons(editing) {
  document.getElementById("editBtn").style.display = editing ? "inline-block" : "none";
  document.getElementById("saveBtn").style.display = editing ? "none" : "inline-block";
}

function handleItemCodeF2(e) {
  if (e.key === "F2") {
    e.preventDefault();
    showItemPopup();
  }
}

function showItemPopup() {
  const popup = document.getElementById("itemListTable");
  popup.style.display = "block";
  fillItemListTable();
}

function fillItemListTable() {
  const tbody = document.getElementById("itemListBody");
  tbody.innerHTML = "";
  Object.entries(itemDB).forEach(([code, item]) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${code}</td><td>${item.name}</td>`;
    tr.onclick = () => {
      selectItemCode(code);
    };
    tbody.appendChild(tr);
  });
  document.getElementById("itemSearchInput").value = "";
  document.getElementById("itemSearchInput").focus();
}

function filterItemList() {
  const filter = document.getElementById("itemSearchInput").value.toLowerCase();
  const tbody = document.getElementById("itemListBody");
  tbody.innerHTML = "";
  Object.entries(itemDB).forEach(([code, item]) => {
    if (code.includes(filter) || item.name.toLowerCase().includes(filter)) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${code}</td><td>${item.name}</td>`;
      tr.onclick = () => {
        selectItemCode(code);
      };
      tbody.appendChild(tr);
    }
  });
}

function selectItemCode(code) {
  const item = itemDB[code];
  document.getElementById("itemCode").value = code;
  document.getElementById("itemName").value = item.name;
  document.getElementById("packSize").value = item.ps || "";
  document.getElementById("costPrice").value = item.cost;
  document.getElementById("sellPrice").value = item.sell;
  document.getElementById("supplierName").value = item.supplier;
  disableItemForm();
  showEditDeleteButtons(true);
  document.getElementById("itemListTable").style.display = "none";
}

// ---------- MY STOCK ----------

function handleStockItemF2(e) {
  if (e.key === "F2") {
    e.preventDefault();
    showStockItemPopup();
  }
}

function showStockItemPopup() {
  const popup = document.getElementById("stockItemListTable");
  popup.style.display = "block";
  fillStockItemListTable();
}

function fillStockItemListTable() {
  const tbody = document.getElementById("stockItemListBody");
  tbody.innerHTML = "";
  Object.entries(itemDB).forEach(([code, item]) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${code}</td><td>${item.name}</td>`;
    tr.onclick = () => {
      selectStockItemCode(code);
    };
    tbody.appendChild(tr);
  });
  document.getElementById("stockItemSearchInput").value = "";
  document.getElementById("stockItemSearchInput").focus();
}

function filterStockItemList() {
  const filter = document.getElementById("stockItemSearchInput").value.toLowerCase();
  const tbody = document.getElementById("stockItemListBody");
  tbody.innerHTML = "";
  Object.entries(itemDB).forEach(([code, item]) => {
    if (code.includes(filter) || item.name.toLowerCase().includes(filter)) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${code}</td><td>${item.name}</td>`;
      tr.onclick = () => {
        selectStockItemCode(code);
      };
      tbody.appendChild(tr);
    }
  });
}

function selectStockItemCode(code) {
  const item = itemDB[code];
  document.getElementById("stockItemCode").value = code;
  document.getElementById("stockItemName").textContent = item.name;
  document.getElementById("stockItemListTable").style.display = "none";
}

function checkStockItem() {
  const code = document.getElementById("stockItemCode").value;
  const item = itemDB[code];
  if (!item) {
    document.getElementById("stockResult").textContent = "Item not found.";
    return;
  }
  document.getElementById("stockResult").textContent = `Item: ${item.name}, Stock: ${item.sih || 0}`;
}

// ---------- TRANSFER IN ----------

function setupLocationSelects() {
  const userLoc = document.getElementById("userLocation").textContent;
  const fromLocSelectIn = document.getElementById("transferInFromLocation");
  const toLocSelectIn = document.getElementById("transferInToLocation");
  const fromLocSelectOut = document.getElementById("transferOutFromLocation");
  const toLocSelectOut = document.getElementById("transferOutToLocation");

  fromLocSelectIn.innerHTML = "";
  toLocSelectIn.innerHTML = "";
  fromLocSelectOut.innerHTML = "";
  toLocSelectOut.innerHTML = "";

  locations.forEach(loc => {
    // Transfer In from location selectable, to location fixed to user location
    const optionFromIn = document.createElement("option");
    optionFromIn.value = loc;
    optionFromIn.textContent = loc;
    fromLocSelectIn.appendChild(optionFromIn);

    // Transfer In to location fixed to user location, disabled
    const optionToIn = document.createElement("option");
    optionToIn.value = userLoc;
    optionToIn.textContent = userLoc;
    toLocSelectIn.appendChild(optionToIn);

    // Transfer Out from location fixed to user location, disabled
    const optionFromOut = document.createElement("option");
    optionFromOut.value = userLoc;
    optionFromOut.textContent = userLoc;
    fromLocSelectOut.appendChild(optionFromOut);

    // Transfer Out to location selectable, excluding user location
    if (loc !== userLoc) {
      const optionToOut = document.createElement("option");
      optionToOut.value = loc;
      optionToOut.textContent = loc;
      toLocSelectOut.appendChild(optionToOut);
    }
  });
  toLocSelectIn.disabled = true;
  fromLocSelectOut.disabled = true;
  toLocSelectIn.value = userLoc;
  fromLocSelectOut.value = userLoc;
}

// Transfer In Items List
function transferInAddItem() {
  const code = prompt("Enter Item Code or Name:");
  if (!code) return;

  // Find item by code or name
  const codeFound = findItemCode(code);
  if (!codeFound) {
    alert("Item not found.");
    return;
  }
  const item = itemDB[codeFound];
  const tbody = document.querySelector("#transferInTable tbody");

  // Check if item already in table - do not duplicate
  const exists = Array.from(tbody.children).some(tr => tr.dataset.code === codeFound);
  if (exists) {
    alert("Item already added.");
    return;
  }

  const newRow = document.createElement("tr");
  newRow.dataset.code = codeFound;
  newRow.innerHTML = `
    <td>${tbody.children.length + 1}</td>
    <td>${codeFound}</td>
    <td>${item.name}</td>
    <td>${item.ps}</td>
    <td><input type="date" value="${item.expDates.length > 0 ? item.expDates[0] : ''}" /></td>
    <td><input type="number" value="${item.cost}" step="0.01" min="0" /></td>
    <td><input type="number" value="0" min="0" /></td>
    <td><input type="number" value="0" readonly /></td>
    <td><button onclick="removeRow(this)">X</button></td>
  `;
  tbody.appendChild(newRow);
  setupTransferInRowEvents(newRow);
  transferInCalculate();
}

function setupTransferInRowEvents(row) {
  const qtyInput = row.children[6].querySelector("input");
  const costInput = row.children[5].querySelector("input");
  const amountInput = row.children[7].querySelector("input");
  function recalc() {
    const qty = parseFloat(qtyInput.value) || 0;
    const cost = parseFloat(costInput.value) || 0;
    amountInput.value = (qty * cost).toFixed(2);
    transferInCalculate();
  }
  qtyInput.addEventListener("input", recalc);
  costInput.addEventListener("input", recalc);
}

function transferInCalculate() {
  const tbody = document.querySelector("#transferInTable tbody");
  let gross = 0;
  Array.from(tbody.children).forEach(row => {
    const amount = parseFloat(row.children[7].querySelector("input").value) || 0;
    gross += amount;
  });
  const discount = parseFloat(document.getElementById("transferInDiscount").value) || 0;
  const tax = parseFloat(document.getElementById("transferInTax").value) || 0;
  document.getElementById("transferInGross").value = gross.toFixed(2);
  const net = gross - discount + tax;
  document.getElementById("transferInNet").value = net.toFixed(2);
}

function transferInSave() {
  const docNo = document.getElementById("transferInDocNo").value;
  const fromLoc = document.getElementById("transferInFromLocation").value;
  const toLoc = document.getElementById("transferInToLocation").value;
  const remark = document.getElementById("transferInRemark").value;
  const tbody = document.querySelector("#transferInTable tbody");
  if (!fromLoc) {
    alert("Select From Location");
    return;
  }
  if (tbody.children.length === 0) {
    alert("Add at least one item");
    return;
  }

  let items = [];
  for (const row of tbody.children) {
    const code = row.children[1].textContent;
    const expDate = row.children[4].querySelector("input").value;
    const cost = parseFloat(row.children[5].querySelector("input").value) || 0;
    const qty = parseFloat(row.children[6].querySelector("input").value) || 0;
    const unit = qty; // Assuming unit = qty here, adjust if needed
    const amount = parseFloat(row.children[7].querySelector("input").value) || 0;
    if(qty <= 0) {
      alert(`Quantity must be > 0 for item ${code}`);
      return;
    }
    items.push({ code, expDate, cost, qty, unit, amount });
  }

  transferInDB.push({ docNo, fromLoc, toLoc, remark, items });
  alert("Transfer In saved: Doc No " + docNo);
  clearTransferInForm();
  document.getElementById("transferInDocNo").value = transferInDB.length + 1;
}

function clearTransferInForm() {
  document.getElementById("transferInRemark").value = "";
  const tbody = document.querySelector("#transferInTable tbody");
  tbody.innerHTML = "";
  document.getElementById("transferInGross").value = "0";
  document.getElementById("transferInDiscount").value = "0";
  document.getElementById("transferInTax").value = "0";
  document.getElementById("transferInNet").value = "0";
}

function removeRow(btn) {
  const tr = btn.closest("tr");
  tr.remove();
  transferInCalculate();
}

// ---------- TRANSFER OUT ----------

function transferOutAddItem() {
  const codeOrName = prompt("Enter Item Code or Name:");
  if (!codeOrName) return;

  const codeFound = findItemCode(codeOrName);
  if (!codeFound) {
    alert("Item not found.");
    return;
  }
  const item = itemDB[codeFound];
  const tbody = document.querySelector("#transferOutTable tbody");

  // Check if item already added
  const exists = Array.from(tbody.children).some(tr => tr.dataset.code === codeFound);
  if (exists) {
    alert("Item already added.");
    return;
  }

  // Must select exp date from available stock expDates
  // For Transfer Out, show a select dropdown for expDates, with stock info

  const expDatesOptions = item.expDates.map(ed => `<option value="${ed}">${ed}</option>`).join("");
  const sih = item.sih || 0;

  if (sih <= 0) {
    alert("No stock available for this item");
    return;
  }

  const newRow = document.createElement("tr");
  newRow.dataset.code = codeFound;
  newRow.innerHTML = `
    <td>${tbody.children.length + 1}</td>
    <td>${codeFound}</td>
    <td>${item.name}</td>
    <td>${item.ps}</td>
    <td>
      <select class="expDateSelect" onchange="transferOutUpdateSih(this)">
        ${expDatesOptions}
      </select>
    </td>
    <td>${item.cost.toFixed(2)}</td>
    <td><input type="number" class="sihBox" readonly value="${sih}" style="width: 60px;"></td>
    <td><input type="number" class="qtyBox" min="0" max="${sih}" value="0" style="width: 60px;" oninput="transferOutUpdateAmount(this)"></td>
    <td><input type="number" class="amountBox" readonly value="0" style="width: 80px;"></td>
    <td><button onclick="removeRow(this)">X</button></td>
  `;
  tbody.appendChild(newRow);
  transferOutCalculate();
}

function transferOutUpdateSih(selectElem) {
  const tr = selectElem.closest("tr");
  const code = tr.dataset.code;
  const item = itemDB[code];
  // For simplicity, we show full stock for now in SIH, not per expiry date
  // To track per expiry date stock, system design needs deeper tracking (not implemented here)
  tr.querySelector(".sihBox").value = item.sih || 0;
  // Reset qty and amount
  const qtyBox = tr.querySelector(".qtyBox");
  const amountBox = tr.querySelector(".amountBox");
  qtyBox.value = 0;
  amountBox.value = 0;
  transferOutCalculate();
}

function transferOutUpdateAmount(qtyInput) {
  const tr = qtyInput.closest("tr");
  const cost = parseFloat(tr.children[5].textContent);
  const qty = parseFloat(qtyInput.value) || 0;
  const sih = parseFloat(tr.querySelector(".sihBox").value) || 0;
  if(qty > sih) {
    alert("Quantity cannot be more than stock on hand");
    qtyInput.value = sih;
  }
  tr.querySelector(".amountBox").value = (qtyInput.value * cost).toFixed(2);
  transferOutCalculate();
}

function transferOutCalculate() {
  const tbody = document.querySelector("#transferOutTable tbody");
  let gross = 0;
  Array.from(tbody.children).forEach(row => {
    const amount = parseFloat(row.querySelector(".amountBox").value) || 0;
    gross += amount;
  });
  const discount = parseFloat(document.getElementById("transferOutDiscount").value) || 0;
  const tax = parseFloat(document.getElementById("transferOutTax").value) || 0;
  document.getElementById("transferOutGross").value = gross.toFixed(2);
  const net = gross - discount + tax;
  document.getElementById("transferOutNet").value = net.toFixed(2);
}

function transferOutSave() {
  const docNo = document.getElementById("transferOutDocNo").value;
  const fromLoc = document.getElementById("transferOutFromLocation").value;
  const toLoc = document.getElementById("transferOutToLocation").value;
  const remark = document.getElementById("transferOutRemark").value;
  const tbody = document.querySelector("#transferOutTable tbody");

  if (!toLoc) {
    alert("Select To Location");
    return;
  }
  if (tbody.children.length === 0) {
    alert("Add at least one item");
    return;
  }

  let items = [];
  for (const row of tbody.children) {
    const code = row.children[1].textContent;
    const expDate = row.querySelector("select.expDateSelect").value;
    const cost = parseFloat(row.children[5].textContent);
    const sih = parseFloat(row.querySelector(".sihBox").value) || 0;
    const qty = parseFloat(row.querySelector(".qtyBox").value) || 0;
    const amount = parseFloat(row.querySelector(".amountBox").value) || 0;

    if (qty <= 0) {
      alert(`Quantity must be > 0 for item ${code}`);
      return;
    }
    if (qty > sih) {
      alert(`Quantity cannot exceed SIH for item ${code}`);
      return;
    }
    items.push({ code, expDate, cost, sih, qty, amount });
  }

  currentTransferOut = {
    docNo, fromLoc, toLoc, remark, items, processed: false
  };
  transferOutDB.push(currentTransferOut);
  alert("Transfer Out saved: Doc No " + docNo);
  disableTransferOutAfterSave();
  document.getElementById("transferOutDocNo").value = transferOutDB.length + 1;
}

function disableTransferOutAfterSave() {
  document.getElementById("transferOutSaveBtn").style.display = "none";
  document.getElementById("transferOutEditBtn").style.display = "inline-block";
  document.getElementById("transferOutProcessBtn").style.display = "inline-block";

  // Disable inputs
  document.querySelectorAll("#transferOutTable tbody input, #transferOutTable tbody select").forEach(el => {
    el.disabled = true;
  });
  document.getElementById("transferOutToLocation").disabled = true;
  document.getElementById("transferOutRemark").disabled = true;
}

function transferOutEdit() {
  if (!currentTransferOut) {
    alert("No transfer to edit");
    return;
  }
  document.getElementById("transferOutSaveBtn").style.display = "inline-block";
  document.getElementById("transferOutEditBtn").style.display = "none";
  document.getElementById("transferOutProcessBtn").style.display = "none";

  document.querySelectorAll("#transferOutTable tbody input, #transferOutTable tbody select").forEach(el => {
    el.disabled = false;
  });
  document.getElementById("transferOutToLocation").disabled = false;
  document.getElementById("transferOutRemark").disabled = false;
}

function transferOutProcess() {
  if (!currentTransferOut) {
    alert("No transfer to process");
    return;
  }
  if (currentTransferOut.processed) {
    alert("Already processed");
    return;
  }
  // Deduct qty from stock
  currentTransferOut.items.forEach(item => {
    if (itemDB[item.code]) {
      itemDB[item.code].sih = (itemDB[item.code].sih || 0) - item.qty;
      if (itemDB[item.code].sih < 0) itemDB[item.code].sih = 0;
    }
  });
  localStorage.setItem("itemDB", JSON.stringify(itemDB));
  currentTransferOut.processed = true;
  alert("Transfer Out processed successfully!");
  transferOutEdit();
  disableTransferOutAfterSave();
  currentTransferOut = null;
  resetTransferOutForm();
}

// New function to load Transfer Out by Doc No from saved records
function loadTransferOutByDocNo() {
  const docNoInput = document.getElementById("transferOutDocNo");
  const docNo = docNoInput.value.trim();
  if (!docNo) {
    alert("Please enter a Transfer Out Doc No");
    return;
  }
  const transfer = transferOutDB.find(t => t.docNo === docNo);
  if (!transfer) {
    alert("Transfer Out Doc No not found");
    return;
  }

  // Fill form with transfer details
  document.getElementById("transferOutRemark").value = transfer.remark;
  document.getElementById("transferOutToLocation").value = transfer.toLoc;

  const tbody = document.querySelector("#transferOutTable tbody");
  tbody.innerHTML = "";

  transfer.items.forEach((item, index) => {
    const itemData = itemDB[item.code];
    const newRow = document.createElement("tr");
    const sih = itemData?.sih || 0;
    const expDatesOptions = itemData?.expDates.map(ed => `<option value="${ed}" ${ed === item.expDate ? "selected" : ""}>${ed}</option>`).join("") || "";
    newRow.dataset.code = item.code;
    newRow.innerHTML = `
      <td>${index + 1}</td>
      <td>${item.code}</td>
      <td>${itemData?.name || ""}</td>
      <td>${itemData?.ps || ""}</td>
      <td>
        <select class="expDateSelect" onchange="transferOutUpdateSih(this)">
          ${expDatesOptions}
        </select>
      </td>
      <td>${item.cost.toFixed(2)}</td>
      <td><input type="number" class="sihBox" readonly value="${sih}" style="width: 60px;"></td>
      <td><input type="number" class="qtyBox" min="0" max="${sih}" value="${item.qty}" style="width: 60px;" oninput="transferOutUpdateAmount(this)"></td>
      <td><input type="number" class="amountBox" readonly value="${item.amount.toFixed(2)}" style="width: 80px;"></td>
      <td><button onclick="removeRow(this)">X</button></td>
    `;
    tbody.appendChild(newRow);
  });

  currentTransferOut = transfer;
  disableTransferOutAfterSave();
  alert("Loaded Transfer Out Doc No " + docNo);
}

function resetTransferOutForm() {
  document.getElementById("transferOutRemark").value = "";
  document.querySelector("#transferOutTable tbody").innerHTML = "";
  document.getElementById("transferOutGross").value = "0";
  document.getElementById("transferOutDiscount").value = "0";
  document.getElementById("transferOutTax").value = "0";
  document.getElementById("transferOutNet").value = "0";
  document.getElementById("transferOutSaveBtn").style.display = "inline-block";
  document.getElementById("transferOutEditBtn").style.display = "none";
  document.getElementById("transferOutProcessBtn").style.display = "none";
  document.getElementById("transferOutToLocation").disabled = false;
  document.getElementById("transferOutRemark").disabled = false;

  // Clear doc no after processing
  document.getElementById("transferOutDocNo").value = transferOutDB.length + 1;
}

// ---------- UTILS ----------

function findItemCode(codeOrName) {
  codeOrName = codeOrName.trim().toLowerCase();
  for (const code in itemDB) {
    if (code.toLowerCase() === codeOrName || itemDB[code].name.toLowerCase() === codeOrName) {
      return code;
    }
  }
  // Partial search
  for (const code in itemDB) {
    if (code.toLowerCase().includes(codeOrName) || itemDB[code].name.toLowerCase().includes(codeOrName)) {
      return code;
    }
  }
  return null;
}

// ---------- COMMON FUNCTIONS ----------

function toggleSidebar() {
  document.getElementById("sidebar").classList.toggle("hidden");
}
function toggleMenu(id) {
  const el = document.getElementById(id);
  el.style.display = el.style.display === "block" ? "none" : "block";
}
function showSection(id) {
  document.querySelectorAll(".main-content > div").forEach(div => div.style.display = "none");
  if (id) document.getElementById(id).style.display = "block";
}
function logout() {
  localStorage.clear();
  window.location.href = 'index.html';
}
</script>
</body>
</html>
